// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & USERS
// ============================================

enum Role {
  PARTICIPANT
  VOLUNTEER
  STAFF
}

enum MembershipTier {
  AD_HOC        // Ad-hoc
  ONCE_WEEKLY   // 1x per week
  TWICE_WEEKLY  // 2x per week
  THRICE_PLUS   // 3+ per week
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  role          Role      @default(PARTICIPANT)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  profile              Profile?
  registrations        Registration[]
  volunteerAssignments VolunteerAssignment[]

  @@index([email])
  @@index([role])
}

model Profile {
  id                 String          @id @default(cuid())
  userId             String          @unique
  name               String
  phone              String?
  
  // PARTICIPANT-SPECIFIC FIELDS (required if user.role == PARTICIPANT)
  membershipTier     MembershipTier? // Required for participants
  caregiverName      String?         // Required for participants
  caregiverPhone     String?         // Required for participants - used to send event info
  accessibilityNeeds String[]        // e.g. ["wheelchair", "hearing_aid"]
  
  // VOLUNTEER-SPECIFIC FIELDS
  skills             String[]        // For volunteers
  interests          String[]        // For volunteers
  
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// PROGRAMMES & ACTIVITIES
// ============================================

model Programme {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  activities Activity[]

  @@index([name])
}

enum ActivityType {
  STEP          // Social, Therapeutic, Educational Programme
  WELLNESS
  RECREATION
  EDUCATION
  SOCIAL
  OTHER
}

model Activity {
  id                  String       @id @default(cuid())
  title               String
  description         String?
  programmeId         String
  type                ActivityType @default(OTHER)
  startsAt            DateTime
  endsAt              DateTime
  location            String
  capacity            Int // Max participants
  volunteerRequired   Int          @default(0) // Min volunteers needed
  participantToVolunteerRatio Float? // e.g. 3.0 means 1 volunteer per 3 participants
  accessibilityTags   String[] // e.g. ["wheelchair_friendly", "hearing_loop"]
  tags                String[] // General tags
  imageUrl            String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  programme            Programme             @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  registrations        Registration[]
  volunteerAssignments VolunteerAssignment[]
  formTemplate         FormTemplate?

  @@index([startsAt])
  @@index([programmeId])
  @@index([type])
}

// ============================================
// REGISTRATIONS (Participants)
// ============================================

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  WAITLIST
}

model Registration {
  id            String             @id @default(cuid())
  activityId    String
  participantId String
  status        RegistrationStatus @default(PENDING)
  notes         String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  activity    Activity             @relation(fields: [activityId], references: [id], onDelete: Cascade)
  participant User                 @relation(fields: [participantId], references: [id], onDelete: Cascade)
  answers     RegistrationAnswer[]

  @@unique([activityId, participantId])
  @@index([participantId])
  @@index([activityId])
  @@index([status])
}

// ============================================
// VOLUNTEER ASSIGNMENTS
// ============================================

enum AssignmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

model VolunteerAssignment {
  id          String           @id @default(cuid())
  activityId  String
  volunteerId String
  status      AssignmentStatus @default(PENDING)
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  activity  Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  volunteer User     @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([activityId, volunteerId])
  @@index([volunteerId])
  @@index([activityId])
  @@index([status])
}

// ============================================
// DYNAMIC FORMS
// ============================================

model FormTemplate {
  id         String   @id @default(cuid())
  activityId String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  activity Activity    @relation(fields: [activityId], references: [id], onDelete: Cascade)
  fields   FormField[]
}

enum FieldType {
  TEXT
  TEXTAREA
  NUMBER
  BOOLEAN
  SELECT
  MULTISELECT
  DATE
}

model FormField {
  id                   String    @id @default(cuid())
  templateId           String
  key                  String // e.g. "wheelchair_needed"
  label                String // e.g. "Do you need wheelchair access?"
  type                 FieldType
  required             Boolean   @default(false)
  options              String[] // For SELECT/MULTISELECT
  conditionalLogicJson String? // JSON: { "showIf": { "field": "other_key", "value": true } }
  order                Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  template FormTemplate        @relation(fields: [templateId], references: [id], onDelete: Cascade)
  answers  RegistrationAnswer[]

  @@index([templateId])
  @@index([order])
}

model RegistrationAnswer {
  id             String   @id @default(cuid())
  registrationId String
  fieldId        String
  valueJson      String // Store answer as JSON string
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  field        FormField    @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([registrationId, fieldId])
  @@index([registrationId])
  @@index([fieldId])
}