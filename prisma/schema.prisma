// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PARTICIPANT
  VOLUNTEER
  STAFF
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  WAITLISTED
}

enum VolunteerAssignmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum MembershipTier {
  AD_HOC
  ONE_PER_WEEK
  TWO_PER_WEEK
  THREE_PLUS_PER_WEEK
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?   // hashed
  role          UserRole  @default(PARTICIPANT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profile       Profile?
  accounts      Account[]
  sessions      Session[]
  registrations Registration[]
  assignments   VolunteerAssignment[]
  caregiverLinks CaregiverLink[] @relation("Caregiver")
  participantLinks CaregiverLink[] @relation("Participant")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Profile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  name               String
  phone              String?
  membershipTier     MembershipTier @default(AD_HOC)

  caregiverPhone     String?        // caregiver number
  medicalStatus      String?        // short summary
  medicalHistory     String? @db.Text // longer notes/history

  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyNotes        String? @db.Text

  accessibilityNeeds String[]
  skills             String[]
  interests          String[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Activity {
  id                String   @id @default(cuid())
  title             String
  description       String?  @db.Text
  programmeId       String
  startsAt          DateTime
  endsAt            DateTime
  location          String
  capacity          Int      @default(20)
  volunteerRequired Int      @default(0) // Number of volunteers needed
  volunteerRatio    Float    @default(5.0) // participants per volunteer
  tags              String[] // Activity type tags
  accessibilityTags String[] // Wheelchair-friendly, etc.
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  programme         Programme @relation(fields: [programmeId], references: [id], onDelete: Cascade)
  registrations     Registration[]
  assignments       VolunteerAssignment[]
  formTemplate      FormTemplate?
}

model Registration {
  id         String             @id @default(cuid())
  activityId String
  participantId String
  status     RegistrationStatus @default(PENDING)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  activity   Activity            @relation(fields: [activityId], references: [id], onDelete: Cascade)
  participant User               @relation(fields: [participantId], references: [id], onDelete: Cascade)
  answers    RegistrationAnswer[]

  @@unique([activityId, participantId])
  @@index([participantId])
  @@index([activityId])
}

model VolunteerAssignment {
  id         String                    @id @default(cuid())
  activityId String
  volunteerId String
  status     VolunteerAssignmentStatus @default(PENDING)
  createdAt  DateTime                  @default(now())
  updatedAt  DateTime                  @updatedAt

  activity   Activity                  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  volunteer  User                      @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([activityId, volunteerId])
  @@index([volunteerId])
  @@index([activityId])
}

model CaregiverLink {
  id                String   @id @default(cuid())
  caregiverUserId   String
  participantUserId String
  createdAt         DateTime @default(now())

  caregiver         User     @relation("Caregiver", fields: [caregiverUserId], references: [id], onDelete: Cascade)
  participant       User     @relation("Participant", fields: [participantUserId], references: [id], onDelete: Cascade)

  @@unique([caregiverUserId, participantUserId])
  @@index([caregiverUserId])
  @@index([participantUserId])
}

model FormTemplate {
  id         String      @id @default(cuid())
  activityId String      @unique
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  activity   Activity    @relation(fields: [activityId], references: [id], onDelete: Cascade)
  fields     FormField[]
}

model FormField {
  id                String   @id @default(cuid())
  templateId        String
  key               String   // e.g., "wheelchair_access", "caregiver_attending"
  label             String
  type              String   // "text", "boolean", "select", "number", etc.
  required          Boolean  @default(false)
  options           String?  @db.Text // JSON array for select options
  conditionalLogic  String?  @db.Text // JSON: { showIf: { field: "key", value: true } }
  order             Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  template          FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  answers           RegistrationAnswer[]

  @@index([templateId])
}

model RegistrationAnswer {
  id             String   @id @default(cuid())
  registrationId String
  fieldId        String
  valueJson      String   @db.Text // Store any value as JSON
  createdAt      DateTime @default(now())

  registration   Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  field          FormField    @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([registrationId, fieldId])
  @@index([registrationId])
  @@index([fieldId])
}
